<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>CloudShell Developer Guide : Tips and Tricks</title>
        <meta name="description" content="">
        <link rel="shortcut icon" type="image/png" href="/devguide_7/favicon.png?">
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/devguide_7/css/main.css">
        <link rel="stylesheet" href="/devguide_7/css/prism.css">
        <link rel="stylesheet" href="/devguide_7/css/samples.css">
        <link rel="stylesheet" href="/devguide_7/css/normalize.css">
        <link rel="stylesheet" href="/devguide_7/css/test-hot-block.webflow.css">


        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
        <script src="/devguide_7/js/jquery-3.1.0.min.js"></script>
        <script src="/devguide_7/js/modernizr.js"></script>
        <script src="/devguide_7/js/webflow.js"></script>


        
        <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-81468206-1', 'auto');
 ga('send', 'pageview');

</script>

        <!-- Begin Jekyll SEO tag v2.1.0 -->
<title>Tips and Tricks - CloudShell Developer Guide</title>
<meta property="og:title" content="Tips and Tricks" />
<meta name="description" content="Managing the CloudShell session" />
<meta property="og:description" content="Managing the CloudShell session" />
<link rel="canonical" href="https://qualisystems.github.io/devguide_7/shells/tips-and-tricks.html" />
<meta property="og:url" content="https://qualisystems.github.io/devguide_7/shells/tips-and-tricks.html" />
<meta property="og:site_name" content="CloudShell Developer Guide" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-03-07T23:34:49+02:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@qualisystems" />
<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "Tips and Tricks",
"datePublished": "2017-03-07T23:34:49+02:00",
"description": "Managing the CloudShell session",
"publisher": {"@type": "Organization",
"logo": {"@type": "ImageObject",
"url": "https://qualisystems.github.io/devguide_7/assets/logo.png"}},
"url": "https://qualisystems.github.io/devguide_7/shells/tips-and-tricks.html"}</script>
<!-- End Jekyll SEO tag -->

        
    </head>
    <body>
        <div id="header">
            <div class="container">
                <div class="row">
    <div class="col-md-3 col-sm-4">
        <a class="brand" href="/devguide_7/">
            <img alt="CloudShell Logo" src="/devguide_7/assets/logo.png" />
            CloudShell <small>Developer Guide</small>
        </a>
    </div>
    <div class="col-md-9 col-sm-8">
        <form class="search" action="/devguide_7/search.html">
            <input class="input" id="search-query" type="text" name="q" placeholder="Search" />
            <input class="button" type="submit" value="Search"></input>
        </form>
    </div>
</div>

            </div>
        </div>
        <div class="container">
            <div class="row">
                
                
                    <div id="navigation" class="col-md-3 col-sm-4">
                        <ul class="nav nav-list">
     
     
        <li class="nav-header"></li>
        
        
        
     
        <li class="nav-header">Introduction</li>
        
                <li data-page-id="index.md"><a href="/devguide_7/">The CloudShell DevGuide</a></li>
        
        
        
                    <li data-page-id="_introduction/setting-up-the-development-ide.md" data-order="1"><a href="/devguide_7/introduction/setting-up-the-development-ide.html">Setting up the Development Environment</a></li>
        
     
        <li class="nav-header">Extending cloudshell with shells</li>
        
        
        
                    <li data-page-id="_shells/getting-started.md" data-order="1"><a href="/devguide_7/shells/getting-started.html">Getting Started</a></li>
        
                    <li data-page-id="_shells/shell-driver-overview.md" data-order="2"><a href="/devguide_7/shells/shell-driver-overview.html">Shell Drivers Overview</a></li>
        
                    <li data-page-id="_shells/the-shell-project.md" data-order="3"><a href="/devguide_7/shells/the-shell-project.html">The Shell Project Guide</a></li>
        
                    <li data-page-id="_shells/modeling-the-shell.md" data-order="4"><a href="/devguide_7/shells/modeling-the-shell.html">Modeling the Shell</a></li>
        
                    <li data-page-id="_shells/getting-information-from-cloudshell.md" data-order="5"><a href="/devguide_7/shells/getting-information-from-cloudshell.html">Getting Information from CloudShell</a></li>
        
                    <li data-page-id="_shells/driver-deep-dive.md" data-order="6"><a href="/devguide_7/shells/driver-deep-dive.html">Driver Deep Dive</a></li>
        
                    <li data-page-id="_shells/customizing-driver-commands.md" data-order="6"><a href="/devguide_7/shells/customizing-driver-commands.html">Commands Visibility and Usability</a></li>
        
                    <li data-page-id="_shells/implementing-discovery-for-inventory-shells.md" data-order="7"><a href="/devguide_7/shells/implementing-discovery-for-inventory-shells.html">Implementing Discovery for Inventory Shells</a></li>
        
                    <li data-page-id="_shells/discovering-inventory-snmp.md" data-order="8"><a href="/devguide_7/shells/discovering-inventory-snmp.html">Discovering Inventory using SNMP</a></li>
        
                    <li data-page-id="_shells/debugging-shell-commands.md" data-order="9"><a href="/devguide_7/shells/debugging-shell-commands.html">Debugging Shell Driver Commands</a></li>
        
                    <li data-page-id="_shells/deploying-to-production.md" data-order="11"><a href="/devguide_7/shells/deploying-to-production.html">Deploying to Production</a></li>
        
                    <li data-page-id="_shells/common-driver-recipes.md" data-order="12"><a href="/devguide_7/shells/common-driver-recipes.html">Common Driver Recipes</a></li>
        
                    <li data-page-id="_shells/tips-and-tricks.md" data-order="13"><a href="/devguide_7/shells/tips-and-tricks.html">Tips and Tricks</a></li>
        
     
        <li class="nav-header">Orchestration scripts</li>
        
        
        
                    <li data-page-id="_orchestration/getting-started.md" data-order="1"><a href="/devguide_7/orchestration/getting-started.html">Getting Started</a></li>
        
                    <li data-page-id="_orchestration/getting-information-from-cloudshell.md" data-order="2"><a href="/devguide_7/orchestration/getting-information-from-cloudshell.html">Getting Information from CloudShell</a></li>
        
                    <li data-page-id="_orchestration/script-commands-customization.md" data-order="6"><a href="/devguide_7/orchestration/script-commands-customization.html">Script commands Visibility and Usability</a></li>
        
                    <li data-page-id="_orchestration/scripts-deep-dive.md" data-order="6"><a href="/devguide_7/orchestration/scripts-deep-dive.html">Scripts Deep Dive</a></li>
        
                    <li data-page-id="_orchestration/common-orchestration-recipes.md" data-order="9"><a href="/devguide_7/orchestration/common-orchestration-recipes.html">Common Orchestration Script Recipes</a></li>
        
                    <li data-page-id="_orchestration/the-oob-orchestration.md" data-order="9"><a href="/devguide_7/orchestration/the-oob-orchestration.html">CloudShell's OOB Orchestration</a></li>
        
     
        <li class="nav-header">Integrating cloudshell into the devops cycle</li>
        
        
        
                    <li data-page-id="_devops/devops-integration.md" data-order="1"><a href="/devguide_7/devops/devops-integration.html">Automating CloudShell Sandboxes for DevOps</a></li>
        
     
        <li class="nav-header">Reference</li>
        
        
        
                    <li data-page-id="_reference/python-coding-standards.md" data-order="7"><a href="/devguide_7/reference/python-coding-standards.html">Python Coding Standards</a></li>
        
     
</ul>

                    </div>

                    <div id="content" class="col-md-9 col-sm-8">
                        

<div class="page-header" data-page-id="_shells/tips-and-tricks.md">
    <h2>Tips and Tricks
        
        
          <span style="float: right;font-size: 20px"><small><a href="https://github.com/QualiSystems/devguide_source/tree/master/_shells/tips-and-tricks.md">Suggest edits</a></small></span>
        
    </h2>
</div>

<h3 id="managing-the-cloudshell-session">Managing the CloudShell session</h3>

<p>Creating an instance of CloudShellAPISession can be expensive. Each time such an object is created
a new login request is made, which can impact the performance of the driver/script. In theory
it would be better to create the session once per command and then pass it in a convenient way
to any internal function called in the execution flow.</p>

<p>For Shell drivers, the cloudshell-shell-core contains a convenient object to manage this scope.
We pass this helper the <em>context</em> parameter of the driver command:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">from cloudshell.shell.core.session.cloudshell_session import CloudShellSessionContext
with CloudShellSessionContext(context) as session:
         perform_validations(session)
         do_some_logic(session)
         do_some_more_logic(session)</code></pre></figure>

<h3 id="logging">Logging</h3>

<p>Any logging package can be used with CloudShell. Quali has a customized logging solution
which is thread and process safe, and that organizes logs to different files according to resource
and sandboxes. The Quali logging module is defined in the <em>cloudshell_core</em> package.</p>

<p>The simplest way to get a hold of a logger object is to use the <em>get_qs_logger</em> module:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">from cloudshell.core.logger.qs_logger import get_qs_logger
logger = get_qs_logger(log_category=reservation_id,log_group=resource_name)
logger.info(&quot;log something&quot;)</code></pre></figure>

<p>For the default logger, the <em>log_category</em> parameter defines the folder under which logs will be grouped
whereas the <em>log_group</em> defines the file. The CloudShell convention is to create a folder for each
reservation id and a file for each resource name. For orchestration scripts, the file name
is the environment name.</p>

<p><img src="/devguide_7/assets/log_structure.png" alt="Log Structure" class="img-responsive" /></p>

<p>All logs will be saved on the Execution Server where the driver is running. The folder location will be
relative to the driver in the virtual environment location at:
 <strong><em>%venv%\[drivername]\Lib\site-packages\cloudshell\Logs</em></strong>.  (e.g. C:\ProgramData\QualiSystems\venv\Deployment_Orchestrator_5_2\Lib\site-packages\cloudshell\Logs.)</p>

<p>Under windows, [venv] will be located at <em>%programdata%\qualisystems\venv</em>.</p>

<p>You can then use the regular logging level syntax to write messages as a part of the driver
package or script flow:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">logger.debug(&quot;debug message&quot;)
logger.info(&quot;info message&quot;)
logger.warn(&quot;warning message&quot;
logger.error(&quot;error message&quot;)</code></pre></figure>

<p>Only messages which are greater than the log level currently set for the driver will be saved to file.
Typically, changing the log level to a more verbose value would be done only in order to debug an issue, as
writing too much to the logs can be expensive. You can change the logging level on the ES or driver level.</p>

<p>To change the log level on the driver level, edit the following configuration file:
<strong><em>[venv]\[drivername]\Lib\site-packages\cloudshell\core\logger\qs_config.init</em></strong> and change the
log level value. Notice that this change will only be valid for that virtual environment, so if the driver
is recycled due to inactivity the log level will revert to the default value.</p>

<p>To change the log level for the entire ES, without editing any files, add the following key to the ES
<em>customer.config</em> (change ‘DEBUG’ to the log level you wish to set):</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">&lt;add key=&quot;DefaultPythonEnvrionmentVariables&quot; value=&quot;LOG_LEVEL=DEBUG&quot;/&gt;</code></pre></figure>

<p>You will need to restart the ES following this change.</p>

<p>Similar to the CloudShell API session, its recommended to create a logger once per command and then pass it
to any internal classes that require it. As with the CloudShell API we’ve added some helpers in the <em>cloudshell-shell-core</em>
package which can reduce some of the repetition around creating a logger and create a more explicit scope for it:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">with LoggingSessionContext(command_context) as logger:
    do_something(logger)
    do something_else(logger)</code></pre></figure>

<p>Another repetitive task is to remember to log any exception raised during the driver execution. Here too,
<em>cloudshell-shell-core</em> provides a handy scope:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">with ErrorHandlingContext(logger):
    will_get_automatically_logged_on_exception()</code></pre></figure>

<p>Using this scope any exception raised within the <em>ErrorHandlingContext</em> will be logged, even if no code remembered
to explicitly call the logger.</p>

<h3 id="nested-scopes">Nested scopes</h3>

<p>Finally, nesting the three helpers mentioned in this article makes a lot of sense as they’re not mutually exclusive.
This syntax will also work well:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">def driver_command(self, command_context, request):
    with LoggingSessionContext(command_context) as logger:
        with ErrorHandlingContext(logger):
            with CloudShellSessionContext(command_context) as session:
                do_the_logic(session, logger)</code></pre></figure>

<p>If the heavily nested code seems problematic its always possible to create a module that accepts the function to
run as an input and applies these scopes behind the scenes.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">def do_with_session_and_logging(self, command_context, function):
    with LoggingSessionContext(command_context) as logger:
        with ErrorHandlingContext(logger):
            with CloudShellSessionContext(command_context) as session:
                function(session, logger)

def driver_command(self, command_context, request):
    do_with_session_and_logging(command_context,
                                lambda session, logger: do_the_logic(session, logger))</code></pre></figure>









    <div id="post-nav" class="clearfix">
        
            <a class="prev" href="/devguide_7/shells/common-driver-recipes.html">&laquo; Common Driver Recipes</a>
        
        
    </div>




<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        var disqus_identifier = '_shells/tips-and-tricks.md';
        var disqus_url = 'https://qualisystems.github.io/shells/tips-and-tricks.html';
        this.page.url = "https://qualisystems.github.io/devguide_7/shells/tips-and-tricks.html";  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = disqus_identifier; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//qualidev.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



<script src="/devguide_7/js/search.min.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
  $(function() {
    $('#search-query').lunrSearch({
      indexUrl  : '/devguide_7/js/index.json',           // url for the .json file containing search index data
      results   : '#search-results',          // selector for containing search results element
      template  : '#search-results-template', // selector for Mustache.js template
      titleMsg  : '',   // message attached in front of results (can be empty)
      emptyMsg  : '<p>Nothing found.</p>'     // shown message if search returns no results
    });
  });
</script>

<script>
$(function() {
    page = $(".page-header").attr("data-page-id")
    nav_item = $(".nav li[data-page-id='"+page+"']")
    if (nav_item) {
        $(".nav").find(".active").removeClass("active");
        nav_item.addClass("active");
    }
})
</script>

                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="http://www.quali.com">CloudShell Developer Guide</a>

                </div>
            </div>
        </div>

        <script src="/devguide_7/js/prism.js"></script>

        
        <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-81468206-1', 'auto');
 ga('send', 'pageview');

</script>

        
    </body>
</html>
