<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>CloudShell Developer Guide : Shell Drivers Overview</title>
        <meta name="description" content="">
        <link rel="shortcut icon" type="image/png" href="/devguide_7/favicon.png?">
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/devguide_7/css/main.css">
        <link rel="stylesheet" href="/devguide_7/css/prism.css">
        <link rel="stylesheet" href="/devguide_7/css/samples.css">
        <link rel="stylesheet" href="/devguide_7/css/normalize.css">
        <link rel="stylesheet" href="/devguide_7/css/test-hot-block.webflow.css">


        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
        <script src="/devguide_7/js/jquery-3.1.0.min.js"></script>
        <script src="/devguide_7/js/modernizr.js"></script>
        <script src="/devguide_7/js/webflow.js"></script>


        
        <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-81468206-1', 'auto');
 ga('send', 'pageview');

</script>

        <!-- Begin Jekyll SEO tag v2.1.0 -->
<title>Shell Drivers Overview - CloudShell Developer Guide</title>
<meta property="og:title" content="Shell Drivers Overview" />
<meta name="description" content="What are Shells again?" />
<meta property="og:description" content="What are Shells again?" />
<link rel="canonical" href="https://qualisystems.github.io/devguide_7/shells/shell-driver-overview.html" />
<meta property="og:url" content="https://qualisystems.github.io/devguide_7/shells/shell-driver-overview.html" />
<meta property="og:site_name" content="CloudShell Developer Guide" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-03-07T23:34:49+02:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@qualisystems" />
<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "Shell Drivers Overview",
"datePublished": "2017-03-07T23:34:49+02:00",
"description": "What are Shells again?",
"publisher": {"@type": "Organization",
"logo": {"@type": "ImageObject",
"url": "https://qualisystems.github.io/devguide_7/assets/logo.png"}},
"url": "https://qualisystems.github.io/devguide_7/shells/shell-driver-overview.html"}</script>
<!-- End Jekyll SEO tag -->

        
    </head>
    <body>
        <div id="header">
            <div class="container">
                <div class="row">
    <div class="col-md-3 col-sm-4">
        <a class="brand" href="/devguide_7/">
            <img alt="CloudShell Logo" src="/devguide_7/assets/logo.png" />
            CloudShell <small>Developer Guide</small>
        </a>
    </div>
    <div class="col-md-9 col-sm-8">
        <form class="search" action="/devguide_7/search.html">
            <input class="input" id="search-query" type="text" name="q" placeholder="Search" />
            <input class="button" type="submit" value="Search"></input>
        </form>
    </div>
</div>

            </div>
        </div>
        <div class="container">
            <div class="row">
                
                
                    <div id="navigation" class="col-md-3 col-sm-4">
                        <ul class="nav nav-list">
     
     
        <li class="nav-header"></li>
        
        
        
     
        <li class="nav-header">Introduction</li>
        
                <li data-page-id="index.md"><a href="/devguide_7/">The CloudShell DevGuide</a></li>
        
        
        
                    <li data-page-id="_introduction/setting-up-the-development-ide.md" data-order="1"><a href="/devguide_7/introduction/setting-up-the-development-ide.html">Setting up the Development Environment</a></li>
        
     
        <li class="nav-header">Extending cloudshell with shells</li>
        
        
        
                    <li data-page-id="_shells/getting-started.md" data-order="1"><a href="/devguide_7/shells/getting-started.html">Getting Started</a></li>
        
                    <li data-page-id="_shells/shell-driver-overview.md" data-order="2"><a href="/devguide_7/shells/shell-driver-overview.html">Shell Drivers Overview</a></li>
        
                    <li data-page-id="_shells/the-shell-project.md" data-order="3"><a href="/devguide_7/shells/the-shell-project.html">The Shell Project Guide</a></li>
        
                    <li data-page-id="_shells/modeling-the-shell.md" data-order="4"><a href="/devguide_7/shells/modeling-the-shell.html">Modeling the Shell</a></li>
        
                    <li data-page-id="_shells/getting-information-from-cloudshell.md" data-order="5"><a href="/devguide_7/shells/getting-information-from-cloudshell.html">Getting Information from CloudShell</a></li>
        
                    <li data-page-id="_shells/driver-deep-dive.md" data-order="6"><a href="/devguide_7/shells/driver-deep-dive.html">Driver Deep Dive</a></li>
        
                    <li data-page-id="_shells/customizing-driver-commands.md" data-order="6"><a href="/devguide_7/shells/customizing-driver-commands.html">Commands Visibility and Usability</a></li>
        
                    <li data-page-id="_shells/implementing-discovery-for-inventory-shells.md" data-order="7"><a href="/devguide_7/shells/implementing-discovery-for-inventory-shells.html">Implementing Discovery for Inventory Shells</a></li>
        
                    <li data-page-id="_shells/discovering-inventory-snmp.md" data-order="8"><a href="/devguide_7/shells/discovering-inventory-snmp.html">Discovering Inventory using SNMP</a></li>
        
                    <li data-page-id="_shells/debugging-shell-commands.md" data-order="9"><a href="/devguide_7/shells/debugging-shell-commands.html">Debugging Shell Driver Commands</a></li>
        
                    <li data-page-id="_shells/deploying-to-production.md" data-order="11"><a href="/devguide_7/shells/deploying-to-production.html">Deploying to Production</a></li>
        
                    <li data-page-id="_shells/common-driver-recipes.md" data-order="12"><a href="/devguide_7/shells/common-driver-recipes.html">Common Driver Recipes</a></li>
        
                    <li data-page-id="_shells/tips-and-tricks.md" data-order="13"><a href="/devguide_7/shells/tips-and-tricks.html">Tips and Tricks</a></li>
        
     
        <li class="nav-header">Orchestration scripts</li>
        
        
        
                    <li data-page-id="_orchestration/getting-started.md" data-order="1"><a href="/devguide_7/orchestration/getting-started.html">Getting Started</a></li>
        
                    <li data-page-id="_orchestration/getting-information-from-cloudshell.md" data-order="2"><a href="/devguide_7/orchestration/getting-information-from-cloudshell.html">Getting Information from CloudShell</a></li>
        
                    <li data-page-id="_orchestration/script-commands-customization.md" data-order="6"><a href="/devguide_7/orchestration/script-commands-customization.html">Script commands Visibility and Usability</a></li>
        
                    <li data-page-id="_orchestration/scripts-deep-dive.md" data-order="6"><a href="/devguide_7/orchestration/scripts-deep-dive.html">Scripts Deep Dive</a></li>
        
                    <li data-page-id="_orchestration/common-orchestration-recipes.md" data-order="9"><a href="/devguide_7/orchestration/common-orchestration-recipes.html">Common Orchestration Script Recipes</a></li>
        
                    <li data-page-id="_orchestration/the-oob-orchestration.md" data-order="9"><a href="/devguide_7/orchestration/the-oob-orchestration.html">CloudShell's OOB Orchestration</a></li>
        
     
        <li class="nav-header">Integrating cloudshell into the devops cycle</li>
        
        
        
                    <li data-page-id="_devops/devops-integration.md" data-order="1"><a href="/devguide_7/devops/devops-integration.html">Automating CloudShell Sandboxes for DevOps</a></li>
        
     
        <li class="nav-header">Reference</li>
        
        
        
                    <li data-page-id="_reference/python-coding-standards.md" data-order="7"><a href="/devguide_7/reference/python-coding-standards.html">Python Coding Standards</a></li>
        
     
</ul>

                    </div>

                    <div id="content" class="col-md-9 col-sm-8">
                        

<div class="page-header" data-page-id="_shells/shell-driver-overview.md">
    <h2>Shell Drivers Overview
        
        
          <span style="float: right;font-size: 20px"><small><a href="https://github.com/QualiSystems/devguide_source/tree/master/_shells/shell-driver-overview.md">Suggest edits</a></small></span>
        
    </h2>
</div>

<h4 id="what-are-shells-again">What are Shells again?</h4>

<p>Shells are a way to extend CloudShell by adding support for different types of sandbox elements such as apps,
virtual appliances or physical resources. A shell can contain the bare minimum required to be able to model
the sandbox element in CloudShell, how categorize it or which unique attributes it possesses.
The Shell can also define the interface through which users can orchestrate or configure an app or a resource
by executing commands. Example commands would be saving, restoring, restarting, performing health checks,
administrative operations or scaling up or down.</p>

<h4 id="what-are-shell-drivers">What are Shell drivers</h4>

<p>A Shell driver is an optional component in the Shell project that allows adding commands to Shells.
CloudShell creates and manages dedicated instances of the driver to communicate with each physical
resource or app. When the user executes a command, either from the Sandbox UI or the API, CloudShell
ensures a driver for the target resource or app is currently running, then sends the command to the driver and
relays back the response.</p>

<p>The driver can contain multiple files and folders but only one file contains a class which is considered to
be the main driver class. This main class defines the Shell commands the driver provides.
The default ShellFoundry template will generate the main driver class and place it inside the <em>driver.py</em>
file located in the <em>src</em> directory. The generated class name will correspond to the Shell name, which is
also the CloudShell convention.</p>

<h4 id="how-cloudshell-manages-the-shell-drivers">How CloudShell manages the Shell drivers</h4>

<p>When the user executes a command for the first time on a deployed app or inventory resource in the Sandbox, CloudShell will
initialize a driver object from the Shell driver class. The object will be created in its own isolated
process, separate from other object instances of that same driver which may be driving other shell
instances - other devices or apps. The Python process will initialize the driver class as a new
object and will from that point on communicate with it to handle any commands.</p>

<p>Inventory and app shell drivers behave a bit differently in terms of their lifecycle:</p>

<ul>
  <li><strong>App Shells</strong> - As apps are deployed in the scope of the sandbox, the app shell driver is also instanced for
  the deployed app in the sandbox. Each app deployed in a sandbox will have its own driver instance managed by
  CloudShell. This means that if there are currently twenty active sandboxes and a MySql app has been deployed
  in each one, twenty shell driver instances will be created, one to talk with each app in the sandbox.</li>
</ul>

<p><img src="/devguide_7/assets/app_shell_arch.png" alt="Shell Commands" /></p>

<ul>
  <li><strong>Inventory Shells</strong> - For inventory Shells, a dedicated driver is managed per Inventory Shell resource instance. If you take for example a shell for physical switch like the NX-OS shell for Cisco switches, a shell driver instance will be created for each managed Cisco switch in your inventory. In this case, since the switch is a permanent inventory item and not created per sandbox, the driver is also instantiated per device.</li>
</ul>

<p><img src="/devguide_7/assets/inventory_shell_arch.png" alt="Shell Commands" /></p>

<p>Whether a deployed app or an inventory component, CloudShell will handle routing commands to the right driver instance. When the user executes a command on a shell instance, CloudShell will first check if a driver instance is already running for the Shell instance, find on which execution server is running, and send the command to that driver to handle. If a driver is not yet running,
for that inventory resource or app, a new driver instance will be launched.</p>

<h4 id="python-virtual-environment">Python virtual environment</h4>

<p>The first time a driver instance is created for a specific driver, CloudShell will create a virtual environment for that driver on the execution server machine. All driver instances will then share that virtual environment. As a part of setting up the virtual environment, the execution server will try to install all of the driver dependences listed in the <em>requirements.txt</em> file, located in the <em>src</em> directory.
If a newer version exists for one of the driver requirements, a new virtual environment will be created the next time a driver instance is initialized with the updated packages.</p>

<h4 id="the-shell-driver-instance-lifecycle">The Shell driver instance lifecycle</h4>

<p>A driver instance is started the first time a command is sent to the resource or deployed app.
As a part of the driver initialization the <em>initialize</em> function of the driver is called. This function
is guaranteed to be the first command executed on the driver and no other command is allowed to run until
it completes successfully. Once complete, the driver can handle commands normally.</p>

<p>After a certain duration of inactivity, the CloudShell Server can opt to stop the driver instance until
its needed again. When the driver instance is stopped  the <em>cleanup</em> function is first called,
allowing any cleanup code to run and prepare the driver for shutdown.</p>

<p>The <em>initialize</em> and <em>cleanup</em> functions have a simple interface. If you generated your Shell
project using ShellFoundry they should already be included in the generated <em>driver.py</em> file.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">def initialize(self, context):
    &quot;&quot;&quot;
    Initialize the driver session, this function is called every time a new instance of the driver is created
    This is a good place to load and cache the driver configuration, initiate sessions etc.
    :param InitCommandContext context: the context the command runs on
    &quot;&quot;&quot;
    pass

def cleanup(self):
    &quot;&quot;&quot;
    Destroy the driver session, this function is called every time a driver instance is destroyed
    This is a good place to close any open sessions, finish writing to log files
    &quot;&quot;&quot;
    pass</code></pre></figure>

<p>The <em>initialize</em> function is a good place to add code you expect to be called once during the
lifecycle of the driver object. You should take into account that the driver is not guaranteed to run
forever. The Quali server might choose to stop the driver instance due to inactivity. In general,
it is recommended to keep the driver as stateless as possible, this will remove a lot of the complexity
of cleanup and state recovery.</p>

<p>The <em>cleanup</em> function will be called whenever the driver instance is stopped. You can place any code that persists the current state of the driver, disconnects sessions or stop any external processes here.</p>

<p><img src="/devguide_7/assets/driver_lifecycle.png" alt="Shell Commands" /></p>

<h4 id="commands-concurrency">Commands Concurrency</h4>

<p>By default, CloudShell will run Shell drivers in sequential mode. This means that CloudShell will send out commands to the driver one at a time and maintain a queue of pending commands if multiple executions are initiated. However, the shell can be configured to handle commands concurrently as well, in which case it becomes the responsibility of the driver developer to handle the concurrency and introduce mutexes where required.
Weâ€™ll review that option and how to configure it in the <a href="https://qualisystems.github.io/devguide_7/shells/customizing-driver-commands.html">Shell customization section</a>.</p>

<h4 id="conclusion">Conclusion</h4>

<p>Hopefully this section provided a good overview of what shells are and how drivers fit into the picture. How drivers are scoped, what entities they are assigned to and what their basic lifecycle is.</p>








    <div id="post-nav" class="clearfix">
        
            <a class="prev" href="/devguide_7/shells/getting-started.html">&laquo; Getting Started</a>
        
        
            <a class="next" href="/devguide_7/shells/the-shell-project.html">The Shell Project Guide &raquo;</a>
        
    </div>




<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        var disqus_identifier = '_shells/shell-driver-overview.md';
        var disqus_url = 'https://qualisystems.github.io/shells/shell-driver-overview.html';
        this.page.url = "https://qualisystems.github.io/devguide_7/shells/shell-driver-overview.html";  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = disqus_identifier; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//qualidev.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



<script src="/devguide_7/js/search.min.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
  $(function() {
    $('#search-query').lunrSearch({
      indexUrl  : '/devguide_7/js/index.json',           // url for the .json file containing search index data
      results   : '#search-results',          // selector for containing search results element
      template  : '#search-results-template', // selector for Mustache.js template
      titleMsg  : '',   // message attached in front of results (can be empty)
      emptyMsg  : '<p>Nothing found.</p>'     // shown message if search returns no results
    });
  });
</script>

<script>
$(function() {
    page = $(".page-header").attr("data-page-id")
    nav_item = $(".nav li[data-page-id='"+page+"']")
    if (nav_item) {
        $(".nav").find(".active").removeClass("active");
        nav_item.addClass("active");
    }
})
</script>

                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="http://www.quali.com">CloudShell Developer Guide</a>

                </div>
            </div>
        </div>

        <script src="/devguide_7/js/prism.js"></script>

        
        <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-81468206-1', 'auto');
 ga('send', 'pageview');

</script>

        
    </body>
</html>
