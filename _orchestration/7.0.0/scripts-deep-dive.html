<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width">

        <title>CloudShell Developer Guide : Scripts Deep Dive</title>
        <meta name="description" content="">
        <link rel="shortcut icon" type="image/png" href="/devguide_7/favicon.png?">
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="/devguide_7/css/main.css">
        <link rel="stylesheet" href="/devguide_7/css/prism.css">
        <link rel="stylesheet" href="/devguide_7/css/samples.css">
        <link rel="stylesheet" href="/devguide_7/css/normalize.css">
        <link rel="stylesheet" href="/devguide_7/css/test-hot-block.webflow.css">


        <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
        <script src="/devguide_7/js/jquery-3.1.0.min.js"></script>
        <script src="/devguide_7/js/modernizr.js"></script>
        <script src="/devguide_7/js/webflow.js"></script>


        
        <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-81468206-1', 'auto');
 ga('send', 'pageview');

</script>

        <!-- Begin Jekyll SEO tag v2.1.0 -->
<title>Scripts Deep Dive - CloudShell Developer Guide</title>
<meta property="og:title" content="Scripts Deep Dive" />
<meta name="description" content="In this section we’ll take a more in-depth view at scripts and how they can be used most effectively for CloudShell orchestration." />
<meta property="og:description" content="In this section we’ll take a more in-depth view at scripts and how they can be used most effectively for CloudShell orchestration." />
<link rel="canonical" href="https://qualisystems.github.io/devguide_7/orchestration/scripts-deep-dive.html" />
<meta property="og:url" content="https://qualisystems.github.io/devguide_7/orchestration/scripts-deep-dive.html" />
<meta property="og:site_name" content="CloudShell Developer Guide" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-03-07T23:34:49+02:00" />
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@qualisystems" />
<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "Scripts Deep Dive",
"datePublished": "2017-03-07T23:34:49+02:00",
"description": "In this section we’ll take a more in-depth view at scripts and how they can be used most effectively for CloudShell orchestration.",
"publisher": {"@type": "Organization",
"logo": {"@type": "ImageObject",
"url": "https://qualisystems.github.io/devguide_7/assets/logo.png"}},
"url": "https://qualisystems.github.io/devguide_7/orchestration/scripts-deep-dive.html"}</script>
<!-- End Jekyll SEO tag -->

        
    </head>
    <body>
        <div id="header">
            <div class="container">
                <div class="row">
    <div class="col-md-3 col-sm-4">
        <a class="brand" href="/devguide_7/">
            <img alt="CloudShell Logo" src="/devguide_7/assets/logo.png" />
            CloudShell <small>Developer Guide</small>
        </a>
    </div>
    <div class="col-md-9 col-sm-8">
        <form class="search" action="/devguide_7/search.html">
            <input class="input" id="search-query" type="text" name="q" placeholder="Search" />
            <input class="button" type="submit" value="Search"></input>
        </form>
    </div>
</div>

            </div>
        </div>
        <div class="container">
            <div class="row">
                
                
                    <div id="navigation" class="col-md-3 col-sm-4">
                        <ul class="nav nav-list">
     
     
        <li class="nav-header"></li>
        
        
        
     
        <li class="nav-header">Introduction</li>
        
                <li data-page-id="index.md"><a href="/devguide_7/">The CloudShell DevGuide</a></li>
        
        
        
                    <li data-page-id="_introduction/setting-up-the-development-ide.md" data-order="1"><a href="/devguide_7/introduction/setting-up-the-development-ide.html">Setting up the Development Environment</a></li>
        
     
        <li class="nav-header">Extending cloudshell with shells</li>
        
        
        
                    <li data-page-id="_shells/getting-started.md" data-order="1"><a href="/devguide_7/shells/getting-started.html">Getting Started</a></li>
        
                    <li data-page-id="_shells/shell-driver-overview.md" data-order="2"><a href="/devguide_7/shells/shell-driver-overview.html">Shell Drivers Overview</a></li>
        
                    <li data-page-id="_shells/the-shell-project.md" data-order="3"><a href="/devguide_7/shells/the-shell-project.html">The Shell Project Guide</a></li>
        
                    <li data-page-id="_shells/modeling-the-shell.md" data-order="4"><a href="/devguide_7/shells/modeling-the-shell.html">Modeling the Shell</a></li>
        
                    <li data-page-id="_shells/getting-information-from-cloudshell.md" data-order="5"><a href="/devguide_7/shells/getting-information-from-cloudshell.html">Getting Information from CloudShell</a></li>
        
                    <li data-page-id="_shells/driver-deep-dive.md" data-order="6"><a href="/devguide_7/shells/driver-deep-dive.html">Driver Deep Dive</a></li>
        
                    <li data-page-id="_shells/customizing-driver-commands.md" data-order="6"><a href="/devguide_7/shells/customizing-driver-commands.html">Commands Visibility and Usability</a></li>
        
                    <li data-page-id="_shells/implementing-discovery-for-inventory-shells.md" data-order="7"><a href="/devguide_7/shells/implementing-discovery-for-inventory-shells.html">Implementing Discovery for Inventory Shells</a></li>
        
                    <li data-page-id="_shells/discovering-inventory-snmp.md" data-order="8"><a href="/devguide_7/shells/discovering-inventory-snmp.html">Discovering Inventory using SNMP</a></li>
        
                    <li data-page-id="_shells/debugging-shell-commands.md" data-order="9"><a href="/devguide_7/shells/debugging-shell-commands.html">Debugging Shell Driver Commands</a></li>
        
                    <li data-page-id="_shells/deploying-to-production.md" data-order="11"><a href="/devguide_7/shells/deploying-to-production.html">Deploying to Production</a></li>
        
                    <li data-page-id="_shells/common-driver-recipes.md" data-order="12"><a href="/devguide_7/shells/common-driver-recipes.html">Common Driver Recipes</a></li>
        
                    <li data-page-id="_shells/tips-and-tricks.md" data-order="13"><a href="/devguide_7/shells/tips-and-tricks.html">Tips and Tricks</a></li>
        
     
        <li class="nav-header">Orchestration scripts</li>
        
        
        
                    <li data-page-id="_orchestration/getting-started.md" data-order="1"><a href="/devguide_7/orchestration/getting-started.html">Getting Started</a></li>
        
                    <li data-page-id="_orchestration/getting-information-from-cloudshell.md" data-order="2"><a href="/devguide_7/orchestration/getting-information-from-cloudshell.html">Getting Information from CloudShell</a></li>
        
                    <li data-page-id="_orchestration/script-commands-customization.md" data-order="6"><a href="/devguide_7/orchestration/script-commands-customization.html">Script commands Visibility and Usability</a></li>
        
                    <li data-page-id="_orchestration/scripts-deep-dive.md" data-order="6"><a href="/devguide_7/orchestration/scripts-deep-dive.html">Scripts Deep Dive</a></li>
        
                    <li data-page-id="_orchestration/common-orchestration-recipes.md" data-order="9"><a href="/devguide_7/orchestration/common-orchestration-recipes.html">Common Orchestration Script Recipes</a></li>
        
                    <li data-page-id="_orchestration/the-oob-orchestration.md" data-order="9"><a href="/devguide_7/orchestration/the-oob-orchestration.html">CloudShell's OOB Orchestration</a></li>
        
     
        <li class="nav-header">Integrating cloudshell into the devops cycle</li>
        
        
        
                    <li data-page-id="_devops/devops-integration.md" data-order="1"><a href="/devguide_7/devops/devops-integration.html">Automating CloudShell Sandboxes for DevOps</a></li>
        
     
        <li class="nav-header">Reference</li>
        
        
        
                    <li data-page-id="_reference/python-coding-standards.md" data-order="7"><a href="/devguide_7/reference/python-coding-standards.html">Python Coding Standards</a></li>
        
     
</ul>

                    </div>

                    <div id="content" class="col-md-9 col-sm-8">
                        

<div class="page-header" data-page-id="_orchestration/scripts-deep-dive.md">
    <h2>Scripts Deep Dive
        
        
          <span style="float: right;font-size: 20px"><small><a href="https://github.com/QualiSystems/devguide_source/tree/master/_orchestration/scripts-deep-dive.md">Suggest edits</a></small></span>
        
    </h2>
</div>

<p>In this section we’ll take a more in-depth view at scripts and how they can be
used most effectively for CloudShell orchestration.</p>

<h4 id="how-cloudshell-handles-scripts">How CloudShell handles scripts</h4>

<p>CloudShell executes a Python script in a very simple and straightforward way by simply running it with a Python executable.
To send information to the script, CloudShell sets environment variables in the scope of the script process.
These environment variables include information about the sandbox reservation, as well as the script parameters.
The script standard output is returned as the command result. If an exception is raised,
or if a non-zero process result code is returned by the script, the execution will be considered a failure.</p>

<h4 id="using-a-main-function-and-packaging-multiple-files">Using a main function and packaging multiple files</h4>

<p>As scripts become more complex, instead of structuring them as one big function, it is advisable
to create a <em>main</em> function and separate the rest of the logic to different functions. Python
requires including some boilerplate code in addition to the <em>main</em> function to make this work.
Here is some example code demonstrating how to use <em>main</em> functions with scripts:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">import cloudshell.helpers.scripts.cloudshell_scripts_helpers as helpers
import os

def print_keys():
    for key in os.environ:
        print key + &quot; : &quot; + os.environ[key]

def print_app_names(session):
    reservation_details = session.GetReservationDetails().ReservationDescription
    for app in reservation_details.Apps:
        print app.Name

def main():
    session = helpers.get_api_session()
    print_keys()
    print_app_names(session)

if __name__ == &quot;__main__&quot;:
    main()</code></pre></figure>

<p>As you’re writing more complex orchestration scripts, it may become prudent to also separate
the code to multiple files. To do that, we can take advantage of Python’s ability to support executing <em>.zip</em> archives
containing multiple scripts. The only requirement, is that one of the files is named ___main__.py, which is how
the entry point of the Python process is determined.</p>

<h4 id="referencing-other-packages">Referencing other packages</h4>

<p>As opposed to Shell drivers, CloudShell doesn’t look for a requirement.txt file for scripts and doesn’t attempt
to retrieve dependencies from Pypi. The script dependencies must be installed on the Python used by the Execution Server.</p>

<p>On windows machines, the ES will by default use the Python included with the ES installation. It can be found in the
<em>\Python\2.7.10</em> directory under the ES installation folder. If you’re using Linux, the Execution Server will use
the default Python configured in the os. In both cases it is possible, however, to specify a different Python environment. To do so, add the following key
to the execution server <em>customer.config</em> file:</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml">&lt;add key=&quot;ScriptRunnerExecutablePath&quot; value=&quot;PATH_TO_EXECUTABLE&quot; /&gt;</code></pre></figure>

<p>To install a dependency, run the following using the Python executable referenced by the ES:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python -m pip install [PACKAGE_NAME]</code></pre></figure>

<p>As dependencies can get complex, it is recommended to keep a centralized <em>requirements.txt</em> file where you can catalog
the requirements of all of the orchestration scripts and add new ones if needed. This will both make it easier to keep
track of the dependencies used by the orchestration scrips and avoid version conflicts, and make it easier to deploy new
Execution Servers. Instead of installing each dependency independently you’ll then be able to run:</p>

<figure class="highlight"><pre><code class="language-bash" data-lang="bash">python -m pip install -r [REQUIREMENTS_FILE_PATH]</code></pre></figure>

<h4 id="setup-and-teardown-scripts">Setup and teardown scripts</h4>

<p>Setup and teardown are a special types of orchestration scripts. There are two things that make them
special:</p>

<ol>
  <li>They can’t have any inputs as they are being launched automatically</li>
  <li>If you use the default ‘Python Setup &amp; Teardown’ driver, then simply including a teardown or setup
 script in the reservation and setting a duration for the setup/teardown is enough for CloudShell
 to launch it.</li>
</ol>

<p>To set a script as a teardown or setup script, you need to edit it from the script management page.
One of the fields allows you to select the <em>Script Type</em>. By choosing ‘Setup/Teardown’ the script will take on
that special behavior. Notice that you’ll not be able to run it separately from the environment built in setup and teardown
commands and you won’t be able to add any inputs to it.</p>

<h4 id="debugging-scripts">Debugging scripts</h4>

<p>CloudShell includes some helper functions to make it easier to debug a script by running it
on real sandbox reservation data. The helper functions allow the script to “attach” to a CloudShell
Sandbox, by filling in all of the environment variables of the script so that the same information
is available to it as would be if CloudShell launched it.</p>

<p>To attach to a CloudShell sandbox, first create a sandbox reservation, then add the following code
and fill in the required data for the function parameters.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">import cloudshell.helpers.scripts.cloudshell_dev_helpers as dev_helpers
dev_helpers.attach_to_cloudshell_as(user=&quot;CLOUDSHELL_USER&quot;, password=&quot;CLOUDSHELL_PWD&quot;, domain=&quot;DOMAIN&quot;,
                                    reservation_id=&quot;RESERVATION_ID&quot;, server_address=&quot;ADDRESS&quot;, command_parameters={&quot;NAME&quot;:&quot;VALUE&quot;})</code></pre></figure>

<p>If we include the above code in the example script we provided earlier, we’ll be able to run it locally as
well as from the CloudShell sandbox. The  <em>attach_to_cloudshell_as</em> function will populate all of the blueprint data
as CloudShell would so from the code perspective it doesn’t make a different where its being run from. Furthermore,
the code will ignore the special <em>attach_to_cloudshell_as</em> function if you run it from CloudShell so that there is no
adverse effect to leaving the statement there.</p>

<p>One drawback of using this strategy is that its probably not a good idea to leave your CloudShell credentials in the code itself
in plain sight. That is why we recommend you use a similar function which takes the same information from a file.
Make sure to add that file to the <em>.gitignore</em> list so that it doesn’t get on source control of course.
The following code will have the same effect as the lines above, only it will look for the information in a
JSON file named <em>quali_config.json</em> which should be in the project root.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python">import cloudshell.helpers.scripts.cloudshell_dev_helpers as dev_helpers
dev_helpers.attach_to_cloudshell()</code></pre></figure>

<p>The <em>quali_config.json</em> should have the following structure:</p>

<figure class="highlight"><pre><code class="language-json" data-lang="json">{
    &quot;user&quot; : &quot;USER&quot;,
    &quot;password&quot; : &quot;PASSWORD&quot;,
    &quot;domain&quot; : &quot;DOMAIN&quot;,
    &quot;server_address&quot; : &quot;SERVER_ADDRESS&quot;,
    &quot;cloudshell_api_port&quot; :&quot;CLOUDSHELL_API_PORT&quot;,
    &quot;reservation_id&quot; = &quot;reservation_id&quot;,
    &quot;command_parameters&quot; = { &quot;PARAM_NAME&quot; : &quot;PARAM_VALUE&quot;    }
}</code></pre></figure>









    <div id="post-nav" class="clearfix">
        
            <a class="prev" href="/devguide_7/orchestration/script-commands-customization.html">&laquo; Script commands Visibility and Usability</a>
        
        
            <a class="next" href="/devguide_7/orchestration/common-orchestration-recipes.html">Common Orchestration Script Recipes &raquo;</a>
        
    </div>




<div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
        var disqus_identifier = '_orchestration/scripts-deep-dive.md';
        var disqus_url = 'https://qualisystems.github.io/orchestration/scripts-deep-dive.html';
        this.page.url = "https://qualisystems.github.io/devguide_7/orchestration/scripts-deep-dive.html";  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = disqus_identifier; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//qualidev.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>



<script src="/devguide_7/js/search.min.js" type="text/javascript" charset="utf-8"></script>

<script type="text/javascript">
  $(function() {
    $('#search-query').lunrSearch({
      indexUrl  : '/devguide_7/js/index.json',           // url for the .json file containing search index data
      results   : '#search-results',          // selector for containing search results element
      template  : '#search-results-template', // selector for Mustache.js template
      titleMsg  : '',   // message attached in front of results (can be empty)
      emptyMsg  : '<p>Nothing found.</p>'     // shown message if search returns no results
    });
  });
</script>

<script>
$(function() {
    page = $(".page-header").attr("data-page-id")
    nav_item = $(".nav li[data-page-id='"+page+"']")
    if (nav_item) {
        $(".nav").find(".active").removeClass("active");
        nav_item.addClass("active");
    }
})
</script>

                    </div>
                
            </div>

            

            <div class="row">
                <div id="footer" class="col-sm-12">
                    Documentation for <a href="http://www.quali.com">CloudShell Developer Guide</a>

                </div>
            </div>
        </div>

        <script src="/devguide_7/js/prism.js"></script>

        
        <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
 (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
 m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
 })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

 ga('create', 'UA-81468206-1', 'auto');
 ga('send', 'pageview');

</script>

        
    </body>
</html>
